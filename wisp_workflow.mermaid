flowchart TD
    subgraph inputs [Inputs]
        tumor_bam[Tumor BAM]
        normal_bam[Normal BAM]
        plasma_bam[Plasma cfDNA BAM]
    end

    subgraph step1 [Step 1: Sample Name Extraction]
        extractTumor[extractTumorName]
        extractNormal[extractNormalName]
        extractPlasma[extractPlasmaName]
    end

    subgraph step2 [Step 2: Primary Tumor Analysis]
        amberPrimary[amberPrimary]
        cobaltPrimary[cobaltPrimary]
        sagePrimary[sagePrimary]
    end

    subgraph step3 [Step 3: Purity and Ploidy Fitting]
        purple[Purple]
    end

    subgraph step4 [Step 4: Plasma Analysis]
        amberPlasma[amberPlasma]
        cobaltPlasma[cobaltPlasma]
    end

    subgraph step5 [Step 5: Merge Directories]
        mergeAmber[mergeAmber]
        mergeCobalt[mergeCobalt]
    end

    subgraph step6 [Step 6: Force-call Plasma]
        sagePlasma[sagePlasma append mode]
    end

    subgraph step7 [Step 7: Tumor Fraction Estimation]
        runWisp[runWisp]
    end

    subgraph outputs [Outputs]
        summary[wisp.summary.tsv]
        snv_results[wisp.snv.tsv]
    end

    tumor_bam --> extractTumor
    normal_bam --> extractNormal
    plasma_bam --> extractPlasma

    tumor_bam --> amberPrimary
    tumor_bam --> cobaltPrimary
    tumor_bam --> sagePrimary
    normal_bam --> amberPrimary
    normal_bam --> cobaltPrimary
    normal_bam --> sagePrimary

    plasma_bam --> amberPlasma
    plasma_bam --> cobaltPlasma
    plasma_bam --> sagePlasma
    normal_bam --> amberPlasma
    normal_bam --> cobaltPlasma

    amberPrimary --> purple
    cobaltPrimary --> purple
    sagePrimary --> purple

    amberPrimary --> mergeAmber
    amberPlasma --> mergeAmber
    cobaltPrimary --> mergeCobalt
    cobaltPlasma --> mergeCobalt

    sagePrimary --> sagePlasma

    purple --> runWisp
    mergeAmber --> runWisp
    mergeCobalt --> runWisp
    sagePlasma --> runWisp

    runWisp --> summary
    runWisp --> snv_results
