## Commands
This section lists command(s) run by wisp workflow

* Running wisp

```
    set -euo pipefail

    if [ -f "~{inputBam}" ]; then
      gatk --java-options "-Xmx~{heapRam}g" GetSampleName -R ~{refFasta} -I ~{inputBam} -O input_name.txt -encode
    fi

    cat input_name.txt
```
```
    set -euo pipefail
    
    # Extract just this chromosome from PON
    bcftools view -r ~{chromosome} ~{PON} -O z -o pon.~{chromosome}.vcf.gz
    tabix -p vcf pon.~{chromosome}.vcf.gz
```
```
    set -euo pipefail

    mkdir ~{file_prefix}.amber

    java -Xmx~{heapRam}G -cp $HMFTOOLS_ROOT/amber.jar com.hartwig.hmftools.amber.AmberApplication \
      -reference ~{normal_name} -reference_bam ~{normal_bam} \
      -tumor ~{tumour_name} -tumor_bam ~{tumour_bam} \
      -output_dir ~{file_prefix}.amber/ \
      -loci ~{PON} \
      -ref_genome_version ~{genomeVersion} \
      -min_mapping_quality ~{min_mapping_quality} \
      -min_base_quality ~{min_base_quality} \
      ~{additionalParameters}

    zip -r ~{file_prefix}.amber.zip ~{file_prefix}.amber/

```
```
    set -euo pipefail

    mkdir -p ~{tumour_name}.amber
    mkdir -p temp

    # Unzip all chromosome results
    for zip_file in ~{sep=' ' chr_zips}; do
      unzip -o ${zip_file} -d temp/
    done

    first_baf=$(ls temp/*/*.amber.baf.tsv.gz | sort -V | sed -n '1p')
    zcat "$first_baf" | sed -n '1p' > temp_header.txt
    zcat temp/*/*.amber.baf.tsv.gz | grep -v "^chromosome" | sort -k1,1V -k2,2n > temp_data.txt
    cat temp_header.txt temp_data.txt | gzip > ~{tumour_name}.amber/~{tumour_name}.amber.baf.tsv.gz
    rm temp_header.txt temp_data.txt

    first_pcf=$(ls temp/*/*.amber.baf.pcf | sort -V | sed -n '1p')
    sed -n '1p' "$first_pcf" > temp_header_pcf.txt
    tail -q -n +2 temp/*/*.amber.baf.pcf | sort -k2,2V -k4,4n > temp_data_pcf.txt
    cat temp_header_pcf.txt temp_data_pcf.txt > ~{tumour_name}.amber/~{tumour_name}.amber.baf.pcf
    rm temp_header_pcf.txt temp_data_pcf.txt

    cp $(find temp -name "*.amber.qc" -type f | sed -n '1p') ~{tumour_name}.amber/~{tumour_name}.amber.qc

    if ls temp/*/*.amber.contamination.tsv 1> /dev/null 2>&1; then
      {
        head -n1 $(ls temp/*/*.amber.contamination.tsv | sort -V | head -n1)
        tail -q -n +2 temp/*/*.amber.contamination.tsv | sort -k1,1V -k2,2n
      } > ~{tumour_name}.amber/~{tumour_name}.amber.contamination.tsv
    fi

    if ls temp/*/*.amber.contamination.vcf.gz 1> /dev/null 2>&1; then
      bcftools concat $(ls temp/*/*.amber.contamination.vcf.gz | sort -V) | \
        bcftools sort -O z -o ~{tumour_name}.amber/~{tumour_name}.amber.contamination.vcf.gz
      tabix -p vcf ~{tumour_name}.amber/~{tumour_name}.amber.contamination.vcf.gz
    fi

    if ls temp/*/*.amber.homozygousregion.tsv 1> /dev/null 2>&1; then
      {
        head -n1 $(ls temp/*/*.amber.homozygousregion.tsv | sort -V | head -n1)
        tail -q -n +2 temp/*/*.amber.homozygousregion.tsv | sort -k1,1V -k2,2n
      } > ~{tumour_name}.amber/~{tumour_name}.amber.homozygousregion.tsv
    fi

    if find temp -name "amber.version" -type f | grep -q .; then
      cp $(find temp -name "amber.version" -type f | head -n1) ~{tumour_name}.amber/amber.version
    fi

    zip -r ~{tumour_name}.amber.zip ~{tumour_name}.amber/
```
```
    set -euo pipefail

    mkdir ~{tumour_name}.cobalt

    java -Xmx~{heapRam}G -cp $HMFTOOLS_ROOT/cobalt.jar com.hartwig.hmftools.cobalt.CobaltApplication \
      -reference ~{normal_name} -reference_bam ~{normal_bam} \
      -tumor ~{tumour_name} -tumor_bam ~{tumour_bam} \
      -output_dir ~{tumour_name}.cobalt/ \
      -gc_profile ~{gcProfile} \
      -pcf_gamma ~{gamma} \
      -min_quality ~{min_mapping_quality} \
      ~{additionalParameters}

    zip -r ~{tumour_name}.cobalt.zip ~{tumour_name}.cobalt/

```
```
    mkdir -p ~{output_name}
    unzip -o ~{primary_zip} -d ~{output_name}/
    unzip -o ~{plasma_zip} -d ~{output_name}/
    # Flatten if nested
    find ~{output_name} -mindepth 2 -type f -exec mv {} ~{output_name}/ \;
    find ~{output_name} -mindepth 1 -type d -empty -delete
    zip -r ~{output_name}.zip ~{output_name}/
```
```
    set -euo pipefail

    mkdir -p ~{reference_name}.sage.bqr
    echo $SAGE_ROOT
    ls -la ${SAGE_ROOT}/

    java -Xmx~{heapRam}G -cp $SAGE_ROOT/sage.jar com.hartwig.hmftools.sage.append.SageAppendApplication \
      -reference ~{reference_name} \
      -reference_bam ~{reference_bam} \
      -ref_genome_version 38 \
      -ref_genome ~{refFasta} \
      -input_vcf ~{input_vcf} \
      -specific_chr ~{chromosome} \
      -output_vcf ~{reference_name}.~{chromosome}.sage.vcf.gz \
      -threads ~{threads} \
      -min_map_quality ~{min_map_quality} \
      -hard_min_tumor_qual ~{hard_min_tumor_qual} \
      -hard_min_tumor_raw_alt_support ~{hard_min_tumor_raw_alt_support} \
      -hard_min_tumor_vaf ~{hard_min_tumor_vaf} \
      ~{additionalParameters}

    mv *.sage.bqr.tsv ~{reference_name}.sage.bqr/ 2>/dev/null || true
    zip -r ~{reference_name}.~{chromosome}.sage.bqr.zip ~{reference_name}.sage.bqr/

```
```
    set -euo pipefail
    
    # Create file list for bcftools concat
    for vcf in ~{sep=' ' vcfs}; do
      echo "$vcf" >> vcf_list.txt
    done
    
    # Sort by chromosome order
    sort -V vcf_list.txt > vcf_list_sorted.txt
    
    # Concatenate VCFs in order
    bcftools concat \
      --file-list vcf_list_sorted.txt \
      --output-type z \
      --output ~{sample_name}.sage.vcf.gz
    
    # Index the merged VCF
    tabix -p vcf ~{sample_name}.sage.vcf.gz
```
```
    set -euo pipefail
  
    mkdir -p ~{sample_name}.sage.bqr
    
    # Unzip each BQR file to a unique directory
    i=0
    for bqr_zip in ~{sep=' ' bqr_zips}; do
      mkdir -p temp_bqr/chr_$i
      unzip -o "$bqr_zip" -d temp_bqr/chr_$i/
      i=$((i + 1))
    done
    
    # Find all BQR TSV files
    bqr_files=($(find temp_bqr -name "*.sage.bqr.tsv" | sort))
    
    if [ ${#bqr_files[@]} -eq 0 ]; then
      echo "No BQR files found!"
      exit 1
    fi
    
    echo "Found ${#bqr_files[@]} BQR files to merge"
    
    # Merge: take header from first file, then all data rows from all files
    cat "${bqr_files[0]}" > ~{sample_name}.sage.bqr/~{sample_name}.sage.bqr.tsv
    
    for bqr_file in "${bqr_files[@]:1}"; do
      tail -n +2 "$bqr_file" >> ~{sample_name}.sage.bqr/~{sample_name}.sage.bqr.tsv
    done
    
    echo "Merged $(wc -l < ~{sample_name}.sage.bqr/~{sample_name}.sage.bqr.tsv) lines total"
    
    # Zip the merged directory
    zip -r ~{sample_name}.sage.bqr.zip ~{sample_name}.sage.bqr/
```
```
    set -euo pipefail

    # Unzip input directories
    unzip ~{purple_dir}
    unzip ~{amber_dir}
    unzip ~{cobalt_dir}
    unzip ~{bqr_dir}

    # Create output directory
    mkdir -p ~{plasma_name}.wisp

    # Run WISP
    java -Xmx~{heapRam}G -jar $WISP_ROOT/wisp.jar \
      -patient_id ~{donor} \
      -tumor_id ~{tumour_name} \
      -samples ~{plasma_name} \
      -purple_dir ~{tumour_name}.solPrimary.purple/ \
      -amber_dir merged_amber/ \
      -cobalt_dir merged_cobalt/ \
      -somatic_vcf ~{somatic_vcf} \
      -bqr_dir ~{plasma_name}.sage.bqr/ \
      -ref_genome ~{refFasta} \
      -output_dir ~{plasma_name}.wisp/ \
      -probe_variants_file ~{probe_variants_file} \
      -threads ~{threads} \
      ~{additionalParameters}

    # Zip output
    zip -r ~{plasma_name}.wisp.zip ~{plasma_name}.wisp/

```
```
    set -euo pipefail

    unzip ~{amber_directory}
    unzip ~{cobalt_directory}
    mkdir ~{outfilePrefix}.purple

    java -Xmx~{heapRam}G -jar $HMFTOOLS_ROOT/purple.jar \
      -ref_genome_version ~{genomeVersion} \
      -ref_genome ~{refFasta}  \
      -gc_profile ~{gcProfile} \
      -ensembl_data_dir ~{ensemblDir}  \
      -reference ~{normal_name} -tumor ~{tumour_name}  \
      -amber ~{tumour_name}.amber -cobalt ~{tumour_name}.cobalt \
      ~{"-ploidy_penalty_factor " + ploidy_penalty_factor} \
      ~{"-ploidy_penalty_standard_deviation " + ploidy_penalty_standard_deviation} \
      ~{"-somatic_vcf " + somatic_vcf} \
      ~{"-min_ploidy " + min_ploidy} \
      ~{"-max_ploidy " + max_ploidy} \
      ~{"-min_purity " + min_purity} \
      ~{"-max_purity " + max_purity} \
      -no_charts \
      -min_diploid_tumor_ratio_count ~{min_diploid_tumor_ratio_count} \
      -output_dir ~{outfilePrefix}.purple \
      ~{additionalParameters}

    zip -r ~{outfilePrefix}.purple.zip ~{outfilePrefix}.purple/

```
```
    # Extract Purple INFO annotations and merge into plasma VCF
    bcftools annotate \
      -a ~{purple_vcf} \
      -c INFO/SUBCL,INFO/PURPLE_VCN,INFO/PURPLE_AF,INFO/PURPLE_CN \
      ~{plasma_sage_vcf} \
      -Oz -o annotated_plasma.vcf.gz
    
    tabix -p vcf annotated_plasma.vcf.gz
```
```
    set -euo pipefail
    
    # Generate probe variants CSV from PASS + HIGH_CONFIDENCE variants
    zcat ~{annotated_vcf} | \
      grep -v "^#" | \
      awk 'BEGIN{print "TumorId,Category,Variant"}
           $7=="PASS" && $8~"TIER=HIGH_CONFIDENCE" {
             printf "~{tumor_id},REPORTABLE_MUTATION,%s:%s %s>%s\n", $1, $2, $4, $5
           }' > ~{outputFileName}
    
    # Verify file has content
    line_count=$(wc -l < ~{outputFileName})
    if [ "$line_count" -le 1 ]; then
      echo "ERROR: No PASS + HIGH_CONFIDENCE variants found for probe file"
      exit 1
    fi
    
    echo "Generated probe variants file with $((line_count - 1)) variants"
```

